<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.bob.stepy.dao.TravelPlanDao">
	<!-- 여행 일정 등록 -->
	<insert id="pRegPlan" parameterType="com.bob.stepy.dto.TravelPlanDto">
		INSERT INTO T
		VALUES (#{t_plannum},#{t_planname},#{t_id},#{t_spot},#{t_stdate},#{t_bkdate},#{t_member1},#{t_member2},#{t_member3},#{t_member4},#{t_member5},DEFAULT)
	</insert>
	<!-- 여행 일정 리스트 가져오기 -->
	<select id="getPlanList" parameterType="String" resultType="com.bob.stepy.dto.TravelPlanDto">
		SELECT * FROM T
		WHERE T_ID=#{id}
	</select>
	<!-- 여행 일정 정보 가져오기 -->
	<select id="getPlan" parameterType="long" resultType="com.bob.stepy.dto.TravelPlanDto">
		SELECT * FROM T
		WHERE T_PLANNUM=#{planNum}
	</select>
	<!-- 여행 일정 설정하기 -->
	<insert id="regPlanContents" parameterType="com.bob.stepy.dto.AccompanyPlanDto">
		INSERT INTO AP (AP_PLANNUM, AP_MID, AP_DAY)
		VALUES (#{ap_plannum},#{ap_mid},#{ap_day})
	</insert>
	<!-- 여행 전체 일수 가져오기 -->
	<select id="getTravelDays" parameterType="long" resultType="int">
		SELECT DISTINCT COUNT(AP_DAY) FROM AP
		WHERE AP_PLANNUM=#{planNum}
	</select>
	<!-- 여행 일정 내용 가져오기 -->
	<select id="getPlanContents" parameterType="long" resultType="com.bob.stepy.dto.AccompanyPlanDto">
		SELECT * FROM AP
		WHERE AP_PLANNUM=#{planNum} ORDER BY AP_PLANCNT
	</select>
	<!-- 가게 정보 가져오기 -->
	<select id="getStoreList" resultType="com.bob.stepy.dto.StoreDto">
		SELECT S_NUM, S_NAME FROM S
	</select>
	<!-- 여행 내용 등록 -->
	<insert id="regAccompanyPlan" parameterType="com.bob.stepy.dto.AccompanyPlanDto">
		INSERT INTO AP
		VALUES (#{ap_plannum},#{ap_mid},#{ap_day},#{ap_plancnt}, #{ap_contents})
	</insert>
	<!-- 여행 내용 삭제 -->
	<delete id="delAccompanyPlan" parameterType="HashMap">
		DELETE FROM AP
		WHERE AP_PLANNUM=#{planNum} AND AP_DAY=#{day} AND AP_PLANCNT=#{num}
	</delete>
	<!-- 여행 내용 수정 -->
	<update id="pEditAccompanyPlan" parameterType="com.bob.stepy.dto.AccompanyPlanDto">
		UPDATE AP
		SET AP_CONTENTS=#{ap_contents}
		WHERE AP_PLANNUM=#{ap_plannum} AND AP_DAY=#{ap_day} AND AP_PLANCNT=#{ap_plancnt}
	</update>
	<!-- 여행 번호 카운트 정렬 -->
	<update id="reduceNumCnt" parameterType="HashMap">
		UPDATE AP
		SET AP_PLANCNT=AP_PLANCNT-1
		WHERE AP_PLANNUM=#{planNum} AND AP_DAY=#{day} AND AP_PLANCNT>#{num}
	</update>
	<!-- 가계부 내용 등록 -->
	<insert id="regHousehold" parameterType="com.bob.stepy.dto.HouseholdDto" useGeneratedKeys="true" keyProperty="h_changecnt">
	<selectKey keyProperty="h_changecnt" resultType="long" order="BEFORE">
		SELECT COUNT(*)+1 FROM H
		WHERE H_PLANNUM=#{h_plannum} AND H_DAY=#{h_day}
	</selectKey>
		INSERT INTO H
		VALUES (#{h_plannum},#{h_day},#{h_changecnt},#{h_mid},#{h_cost},#{h_category},#{h_contents},#{h_sname},DEFAULT,DEFAULT)
	</insert>
	<!-- 가계부 목록 가져오기 -->
	<select id="getHouseholdList" resultType="com.bob.stepy.dto.HouseholdDto">
		SELECT * FROM H
		WHERE H_PLANNUM=#{planNum} ORDER BY H_CNT
	</select>
	<!-- 가계부 내용 가져오기 -->
	<select id="getHouseholdContentes" parameterType="HashMap" resultType="com.bob.stepy.dto.HouseholdDto">
		SELECT * FROM H
		WHERE H_PLANNUM=#{planNum} AND H_DAY=#{day} AND H_CNT=#{householdCnt}
	</select>
	<!-- 가계부 내용 수정 -->
	<update id="ModHousehold" parameterType="com.bob.stepy.dto.HouseholdDto" useGeneratedKeys="true" keyProperty="h_changecnt">
	<selectKey keyProperty="h_changecnt" resultType="long" order="BEFORE">
		SELECT COUNT(*)+1 FROM H
		WHERE H_PLANNUM=#{h_plannum} AND H_DAY=#{h_day}
	</selectKey>
		UPDATE H
		SET H_PLANNUM=#{h_plannum},H_DAY=#{h_day},H_CNT=#{h_changecnt},H_MID=#{h_mid},H_COST=#{h_cost},H_CATEGORY=#{h_category},H_CONTENTS=#{h_contents},H_SNAME=#{h_sname},H_CURDAY=DEFAULT,H_CHANGECNT=DEFAULT
		WHERE H_PLANNUM=#{h_plannum} AND H_DAY=#{h_curday} AND H_CNT=#{h_cnt}
	</update>
	<!-- 가계부 내용 카운트 정렬 -->
	<update id="reduceHouseholdCnt" parameterType="HashMap">
		UPDATE H
		SET H_CNT=H_CNT-1
		WHERE H_PLANNUM=#{planNum} AND H_DAY=#{curDay} AND H_CNT>#{householdCnt}
	</update>
	<!-- 가계부 내용 삭제 -->
	<delete id="delHousehold" parameterType="HashMap">
		DELETE H
		WHERE H_PLANNUM=#{planNum} AND H_DAY=#{curDay} AND H_CNT=#{householdCnt}
	</delete>
	<!-- 예산 등록 -->
	<update id="pRegBudget">
		UPDATE T
		SET T_BUDGET=#{budget}
		WHERE T_PLANNUM=#{planNum}
	</update>
	<!-- 예산 조회 -->
	<select id="getBalance" parameterType="long" resultType="long">
		SELECT H_TOTALCOST
		FROM B
		WHERE H_PLANNUM=#{planNum}
	</select>
</mapper>